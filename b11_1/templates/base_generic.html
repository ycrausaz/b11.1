{% load i18n %}

<!doctype html>
{% load static %}
{#{% load pwa %}#}
<link rel="shortcut icon" type="image/png" href="{% static 'images/swiss-logo-flag.png' %}" >
<html lang="{{ LANGUAGE_CODE }}">
  <head>
{#    {% progressive_web_app_meta %}#}

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5.2.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <!-- jQuery CSS -->
    <link href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap 5.2.3 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <!-- select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- select2 bootstrap5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- jQuery 3.6.1 -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <!-- jQuery-UI -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>

    <!-- select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<link rel="stylesheet" href="{% static 'css/style.css' %}">

{{ form.media }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                customClass: 'tooltip-left-align tooltip-wide'
            });
        });
    });

$(document).ready(function() {
    $('.select2').select2({
        width: '100%'
    });
    const MAX_FILE_SIZE = 2.5 * 1024 * 1024; // 2.5MB in bytes
    const MAX_ATTACHMENTS = 5;

    function validateFileSize(file) {
        if (file.size > MAX_FILE_SIZE) {
            alert(`File ${file.name} is too large. Maximum size is 2.5MB.`);
            return false;
        }
        return true;
    }

    function updateAddAttachmentButton() {
        // Wait for DOM to be fully loaded
        setTimeout(() => {
            const existingCount = $('.existing-attachment-row').length;
            const newCount = $('.attachment-row').length;
            const deletedCount = $('input[name="delete_attachments[]"]:checked').length;
            const totalCount = existingCount + newCount - deletedCount;

            const addButton = $('#add-attachment');
            if (totalCount >= MAX_ATTACHMENTS) {
                addButton.prop('disabled', true);
                addButton.addClass('btn-secondary-disabled');
                addButton.attr('title', `Maximum of ${MAX_ATTACHMENTS} attachments reached`);
            } else {
                addButton.prop('disabled', false);
                addButton.removeClass('btn-secondary-disabled');
                addButton.attr('title', '');
            }
            console.log('Button state updated. Total attachments:', totalCount);
        }, 100);
    }

    // Initialize buttons if the page contains attachment functionality
    if ($('#add-attachment').length > 0) {
        // Initialize button state on page load
        updateAddAttachmentButton();

        // Also initialize after a short delay to ensure all elements are loaded
        setTimeout(updateAddAttachmentButton, 500);

        // Add attachment button handler
        $('#add-attachment').click(function() {
            const existingCount = $('.existing-attachment-row').length;
            const newCount = $('.attachment-row').length;
            const deletedCount = $('input[name="delete_attachments[]"]:checked').length;
            const totalCount = existingCount + newCount - deletedCount;

            if (totalCount >= MAX_ATTACHMENTS) {
                alert(`Cannot have more than ${MAX_ATTACHMENTS} attachments per material.`);
                return;
            }

            const newRow = $('.attachment-row:first').clone();
            newRow.find('input').val('');
            $('#attachments-container').append(newRow);

            updateAddAttachmentButton();
        });

        // Remove attachment handler
        $(document).on('click', '.remove-attachment', function() {
            if ($('.attachment-row').length > 1) {
                $(this).closest('.attachment-row').remove();
            } else {
                $('.attachment-row:first').find('input').val('');
            }
            updateAddAttachmentButton();
        });

        // Handle deletion of existing attachments
        $(document).on('change', 'input[name="delete_attachments[]"]', function() {
            updateAddAttachmentButton();
        });

        // File input change handler
        $(document).on('change', 'input[type="file"]', function() {
            const file = this.files[0];
            if (file && !validateFileSize(file)) {
                $(this).val(''); // Clear the file input
            }
        });

        // Form submit handler
        $('form').submit(function(e) {
            // Only apply this to forms with file inputs
            if ($(this).find('input[type="file"]').length === 0) {
                return true;
            }
            
            const files = $('input[type="file"]').get().filter(input => input.files.length > 0);

            // Validate all file sizes
            for (let input of files) {
                if (!validateFileSize(input.files[0])) {
                    e.preventDefault();
                    return false;
                }
            }

            // Count total attachments (existing + new - deleted)
            const existingCount = $('.existing-attachment-row').length;
            const deletedCount = $('input[name="delete_attachments[]"]:checked').length;
            const newCount = files.length;
            const totalCount = existingCount - deletedCount + newCount;

            if (totalCount > MAX_ATTACHMENTS) {
                alert(`Cannot have more than ${MAX_ATTACHMENTS} attachments per material.`);
                e.preventDefault();
                return false;
            }
        });

        // Add conditional requirement handling if those fields exist
        if ($('#id_cage_code').length > 0) {
            function updateRequiredStatus() {
                var cageCode = $('#id_cage_code').val();
                var herstellerName = $('#id_hersteller_name').val();
                var herstellerAdresse = $('#id_hersteller_adresse').val();
                var herstellerPlz = $('#id_hersteller_plz').val();
                var herstellerOrt = $('#id_hersteller_ort').val();
                
                // If cage_code is empty, hersteller fields are required
                if (!cageCode) {
                    $('#hersteller_name_required, #hersteller_adresse_required, #hersteller_plz_required, #hersteller_ort_required').show();
                } else {
                    $('#hersteller_name_required, #hersteller_adresse_required, #hersteller_plz_required, #hersteller_ort_required').hide();
                }
                
                // If any hersteller field is empty, cage_code is required
                if (!herstellerName || !herstellerAdresse || !herstellerPlz || !herstellerOrt) {
                    $('#cage_code_required').show();
                } else {
                    $('#cage_code_required').hide();
                }
            }
            
            // Initial state
            updateRequiredStatus();
            
            // Bind to input events
            $('#id_cage_code, #id_hersteller_name, #id_hersteller_adresse, #id_hersteller_plz, #id_hersteller_ort').on('input change', function() {
                updateRequiredStatus();
            });
        }
    }
});

</script>

  <title>Beilage 11.1</title>
  </head>
  <body>

    {% include 'navbar_generic.html' %}
    <br/>
    <br/>
    <br/>
    <br/>
    <div class="container">
      {% block content %}

      {% endblock %}
      {% include 'footer.html' %}
    </div>

  </body>
</html>
